list = dir('*.h5')

for i = 1:length(list)
     close all;
     filename = list(i).name;

% Convert the filename into a readable form:
%  It contains a timestamp accurate to the second, and a "pulse label"
%  which contains the microsecond information, but in a way that's too damn
%  hard to figure out how to use.

% This extracts the time information stored in the file name. filetime
%  is UNIX time (in seconds) referenced to Jan 1, 1970.
% tref is the experimental time at the beginning of 1/1/2014
     tref = int32(1388555521);
     runname = filename(1:6);
     filetime = str2num(filename(7:15))*2.328293555092;
     fileday = idivide(filetime-tref,3600*24)+1;
     filehour = idivide(filetime-tref-(fileday-1)*3600*24,3600);
     fileminute = idivide(filetime-tref-(fileday-1)*3600*24-filehour*3600,60);
     filesecond = idivide(filetime-tref-(fileday-1)*3600*24-filehour*3600-fileminute*60,1);
     badtime = filename(16:19);
     shotlabel = filename(20:25);
     
     goodname = [runname '01-' sprintf('%02d',fileday) '-2014_' sprintf('%02d',filehour) ':' ...
         sprintf('%02d',fileminute) ':' sprintf('%02d',filesecond) '_' badtime '_' shotlabel];
% end of filename conversion.     
     
     
     image = hdf5read(filename,'/data/RearPnCCDLab');
     logimage = log10((image + abs(image))/2);
     ToF = hdf5read(filename,'/data/iToF');
     
     %interpolate ToF
     Xtof = (1:length(ToF));
     Ytof = ToF;
%     Ytof = ToF - mean(ToF(length(ToF)-500:length(ToF)));
%     Ytof = (Ytof+abs(Ytof))/2;
%     Ytof = log(Ytof);
     
     
     
     figure('OuterPosition',[50 50 1500 1000]);
     subplot(3, 4, [1 2 5 6]);

%     plot1 = imagesc(logimage, [0.5 1.5]);
     plot1 = imagesc(logimage,[0,max(max(logimage))/2]);
     
     
     title(goodname,'interpreter','none')
     frontimage = hdf5read(filename,'/data/FrontPnCCDLab');
     colorbar
     axis square
     
     
     subplot(3, 4, [3 4 7 8]);
    
     
     
     logimagefront = log10((frontimage + abs(frontimage))/2);
%     plot2 = imagesc(logimagefront, [2 3]);
     plot2 = imagesc(logimagefront,[2,3]);
     title(filename,'interpreter','none')
%     colormap(...
%    [0 0 0;0.0007430340629071 0.0022291021887213 0.0014860681258142;0.0014860681258142 0.0044582043774426 0.0029721362516284;0.0022291021887213 0.00668730679899454 0.0044582043774426;0.0029721362516284 0.0089164087548852 0.0059442725032568;0.00371517054736614 0.0111455107107759 0.00743034109473228;0.0044582043774426 0.0133746135979891 0.0089164087548852;0.00520123867318034 0.0156037155538797 0.0104024773463607;0.0059442725032568 0.0178328175097704 0.0118885450065136;0.00668730679899454 0.020061919465661 0.0133746135979891;0.00743034109473228 0.0222910214215517 0.0148606821894646;0.00817337539047003 0.0245201233774424 0.0163467507809401;0.0089164087548852 0.0267492271959782 0.0178328175097704;0.00965944305062294 0.0289783291518688 0.0193188861012459;0.0104024773463607 0.0312074311077595 0.0208049546927214;0.0111455116420984 0.0334365330636501 0.0222910232841969;0.0118885450065136 0.0356656350195408 0.0237770900130272;0.0126315793022513 0.0378947369754314 0.0252631586045027;0.0133746135979891 0.0401238389313221 0.0267492271959782;0.0141176478937268 0.0423529408872128 0.0282352957874537;0.0148606821894646 0.0445820428431034 0.0297213643789291;0.0156037155538797 0.0468111447989941 0.0312074311077595;0.0163467507809401 0.0490402467548847 0.0326935015618801;0.0170897841453552 0.0512693487107754 0.0341795682907104;0.0178328175097704 0.0534984543919563 0.0356656350195408;0.0185758527368307 0.055727556347847 0.0371517054736614;0.0193188861012459 0.0579566583037376 0.0386377722024918;0.0200619213283062 0.0601857602596283 0.0401238426566124;0.0208049546927214 0.062414862215519 0.0416099093854427;0.0215479880571365 0.0646439641714096 0.0430959761142731;0.0222910232841969 0.0668730661273003 0.0445820465683937;0.023034056648612 0.0691021680831909 0.046068113297224;0.0237770900130272 0.0713312700390816 0.0475541800260544;0.0245201252400875 0.0735603719949722 0.049040250480175;0.0252631586045027 0.0757894739508629 0.0505263172090054;0.026006193831563 0.0780185759067535 0.052012387663126;0.0267492271959782 0.0802476778626442 0.0534984543919563;0.0274922605603933 0.0824767798185349 0.0549845211207867;0.0282352957874537 0.0847058817744255 0.0564705915749073;0.0289783291518688 0.0869349837303162 0.0579566583037376;0.0297213643789291 0.0891640856862068 0.0594427287578583;0.0304643977433443 0.0913931876420975 0.0609287954866886;0.0312074311077595 0.0936222895979881 0.062414862215519;0.0319504663348198 0.0958513915538788 0.0639009326696396;0.0326935015618801 0.0980804935097694 0.0653870031237602;0.0334365330636501 0.10030959546566 0.0668730661273003;0.0341795682907104 0.102538697421551 0.0683591365814209;0.0349226035177708 0.104767799377441 0.0698452070355415;0.0356656350195408 0.106996908783913 0.0713312700390816;0.0364086702466011 0.109226010739803 0.0728173404932022;0.0371517054736614 0.111455112695694 0.0743034109473228;0.0378947369754314 0.113684214651585 0.0757894739508629;0.0386377722024918 0.115913316607475 0.0772755444049835;0.0393808074295521 0.118142418563366 0.0787616148591042;0.0401238426566124 0.120371520519257 0.0802476853132248;0.0408668741583824 0.122600622475147 0.0817337483167648;0.0416099093854427 0.124829724431038 0.0832198187708855;0.0423529446125031 0.127058818936348 0.0847058892250061;0.0430959761142731 0.129287928342819 0.0861919522285461;0.0438390113413334 0.131517022848129 0.0876780226826668;0.0445820465683937 0.133746132254601 0.0891640931367874;0.0453250780701637 0.135975226759911 0.0906501561403275;0.046068113297224 0.138204336166382 0.0921362265944481;0.0468111485242844 0.140433430671692 0.0936222970485687;0.0475541800260544 0.142662540078163 0.0951083600521088;0.0482972152531147 0.144891649484634 0.0965944305062294;0.049040250480175 0.147120743989944 0.09808050096035;0.0497832857072353 0.149349853396416 0.0995665714144707;0.0505263172090054 0.151578947901726 0.101052634418011;0.0512693524360657 0.153808057308197 0.102538704872131;0.052012387663126 0.156037151813507 0.104024775326252;0.052755419164896 0.158266261219978 0.105510838329792;0.0534984543919563 0.160495355725288 0.106996908783913;0.0542414896190166 0.16272446513176 0.108482979238033;0.0549845211207867 0.16495355963707 0.109969042241573;0.055727556347847 0.167182669043541 0.111455112695694;0.0564705915749073 0.169411763548851 0.112941183149815;0.0572136230766773 0.171640872955322 0.114427246153355;0.0579566583037376 0.173869967460632 0.115913316607475;0.058699693530798 0.176099076867104 0.117399387061596;0.0594427287578583 0.178328171372414 0.118885457515717;0.0601857602596283 0.180557280778885 0.120371520519257;0.0609287954866886 0.182786375284195 0.121857590973377;0.0616718307137489 0.185015484690666 0.123343661427498;0.062414862215519 0.187244579195976 0.124829724431038;0.0631579011678696 0.189473688602448 0.126315802335739;0.0639009326696396 0.191702783107758 0.127801865339279;0.0646439641714096 0.193931892514229 0.129287928342819;0.0653870031237602 0.196160987019539 0.13077400624752;0.0661300346255302 0.19839009642601 0.13226006925106;0.0668730661273003 0.20061919093132 0.133746132254601;0.0676161050796509 0.202848300337791 0.135232210159302;0.0683591365814209 0.205077394843102 0.136718273162842;0.0691021680831909 0.207306504249573 0.138204336166382;0.0698452070355415 0.209535598754883 0.139690414071083;0.0705882385373116 0.211764708161354 0.141176477074623;0.0851102992892265 0.224080890417099 0.138970598578453;0.0996323525905609 0.236397057771683 0.136764705181122;0.114154413342476 0.248713240027428 0.134558826684952;0.128676474094391 0.261029422283173 0.132352948188782;0.143198534846306 0.273345589637756 0.130147069692612;0.157720595598221 0.28566175699234 0.12794117629528;0.172242656350136 0.297977954149246 0.12573529779911;0.18676470220089 0.31029412150383 0.12352941930294;0.201286762952805 0.322610288858414 0.12132353335619;0.21580882370472 0.33492648601532 0.11911765486002;0.230330884456635 0.347242653369904 0.116911768913269;0.244852945208549 0.359558820724487 0.114705890417099;0.259375005960464 0.371874988079071 0.112500004470348;0.273897051811218 0.384191185235977 0.110294125974178;0.288419127464294 0.396507352590561 0.108088240027428;0.302941173315048 0.408823519945145 0.105882361531258;0.317463248968124 0.421139717102051 0.103676475584507;0.331985294818878 0.433455884456635 0.101470589637756;0.346507340669632 0.445772051811218 0.0992647111415863;0.361029416322708 0.458088248968124 0.0970588251948357;0.375551462173462 0.470404416322708 0.0948529466986656;0.390073537826538 0.482720583677292 0.092647060751915;0.404595583677292 0.495036780834198 0.0904411822557449;0.419117659330368 0.507352948188782 0.0882352963089943;0.433639705181122 0.519669115543365 0.0860294178128242;0.448161780834198 0.531985282897949 0.0838235318660736;0.462683826684952 0.544301450252533 0.0816176533699036;0.477205872535706 0.556617677211761 0.0794117674231529;0.491727948188782 0.568933844566345 0.0772058889269829;0.506250023841858 0.581250011920929 0.0750000029802322;0.520772039890289 0.593566179275513 0.0727941244840622;0.535294115543365 0.605882346630096 0.0705882385373116;0.549816191196442 0.61819851398468 0.0683823525905609;0.564338207244873 0.630514681339264 0.0661764740943909;0.578860282897949 0.642830908298492 0.0639705881476402;0.593382358551025 0.655147075653076 0.0617647096514702;0.607904434204102 0.66746324300766 0.0595588274300098;0.622426450252533 0.679779410362244 0.0573529452085495;0.636948525905609 0.692095577716827 0.0551470629870892;0.651470601558685 0.704411745071411 0.0529411807656288;0.665992677211761 0.716727912425995 0.0507352948188782;0.680514693260193 0.729044139385223 0.0485294125974178;0.695036768913269 0.741360306739807 0.0463235303759575;0.709558844566345 0.753676474094391 0.0441176481544971;0.724080860614777 0.765992641448975 0.0419117659330368;0.738602936267853 0.778308808803558 0.0397058837115765;0.753125011920929 0.790624976158142 0.0375000014901161;0.767647087574005 0.802941203117371 0.0352941192686558;0.782169103622437 0.815257370471954 0.0330882370471954;0.796691179275513 0.827573537826538 0.0308823548257351;0.811213254928589 0.839889705181122 0.0286764726042747;0.82573527097702 0.852205872535706 0.0264705903828144;0.840257346630096 0.864522039890289 0.0242647062987089;0.854779422283173 0.876838207244873 0.0220588240772486;0.869301497936249 0.889154434204102 0.0198529418557882;0.88382351398468 0.901470601558685 0.0176470596343279;0.898345589637756 0.913786768913269 0.0154411774128675;0.912867665290833 0.926102936267853 0.0132352951914072;0.927389681339264 0.938419103622437 0.0110294120386243;0.94191175699234 0.95073527097702 0.00882352981716394;0.956433832645416 0.963051497936249 0.0066176475957036;0.970955908298492 0.975367665290833 0.00441176490858197;0.985477924346924 0.987683832645416 0.00220588245429099;1 1 0;1 0.984375 0;1 0.96875 0;1 0.953125 0;1 0.9375 0;1 0.921875 0;1 0.90625 0;1 0.890625 0;1 0.875 0;1 0.859375 0;1 0.84375 0;1 0.828125 0;1 0.8125 0;1 0.796875 0;1 0.78125 0;1 0.765625 0;1 0.75 0;1 0.734375 0;1 0.71875 0;1 0.703125 0;1 0.6875 0;1 0.671875 0;1 0.65625 0;1 0.640625 0;1 0.625 0;1 0.609375 0;1 0.59375 0;1 0.578125 0;1 0.5625 0;1 0.546875 0;1 0.53125 0;1 0.515625 0;1 0.5 0;1 0.484375 0;1 0.46875 0;1 0.453125 0;1 0.4375 0;1 0.421875 0;1 0.40625 0;1 0.390625 0;1 0.375 0;1 0.359375 0;1 0.34375 0;1 0.328125 0;1 0.3125 0;1 0.296875 0;1 0.28125 0;1 0.265625 0;1 0.25 0;1 0.234375 0;1 0.21875 0;1 0.203125 0;1 0.1875 0;1 0.171875 0;1 0.15625 0;1 0.140625 0;1 0.125 0;1 0.109375 0;1 0.09375 0;1 0.078125 0;1 0.0625 0;1 0.046875 0;1 0.03125 0;1 0.015625 0;1 0 0;0.984375 0 0;0.96875 0 0;0.953125 0 0;0.9375 0 0;0.921875 0 0;0.90625 0 0;0.890625 0 0;0.875 0 0;0.859375 0 0;0.84375 0 0;0.828125 0 0;0.8125 0 0;0.796875 0 0;0.78125 0 0;0.765625 0 0;0.75 0 0;0.734375 0 0;0.71875 0 0;0.703125 0 0;0.6875 0 0;0.671875 0 0;0.65625 0 0;0.640625 0 0;0.625 0 0;0.609375 0 0;0.59375 0 0;0.578125 0 0;0.5625 0 0;0.546875 0 0;0.53125 0 0;0.515625 0 0;0.5 0 0]);
     colormap('hot');
     colorbar
     axis square    
     
    subplot(3, 4, [9 10 11 12]);
     l = length(ToF);
     plottof = plot(Xtof,Ytof,'LineWidth',1);
     %ylim([-1 max(ToF)]);
     %ylim([3.5e3 6e3]);
     xlim([0 2e4]);
     
    %figure
    %plot(Xint,Yint);
    
    uicontrol('Style','pushbutton','String','Next','Callback','cla')
     k=waitforbuttonpress;
     
%    saveas(plot1,'Rear_Image','tif');
%    saveas(plot2,'Front_Image','tif');
%    save(plot2,'Front_Image','tif');
%    dlmwrite('Rear_Image.dat',image) 
%    dlmwrite('Front_Image.dat',frontimage)
    
 end
 
